- name: Setup Web Servers
  hosts: servers
  become: true
  vars_files:
    - vars/secrets.yml
  vars:
    app_dir: /opt/flask_app
    venv_dir: "{{ app_dir }}/venv"
    db_user_password: "{{ vault_db_user_password }}"
    db_name: employee_db
    db_host: "localhost"
    db_sql_file: employees.sql

  tasks:
    - name: Install all required system packages
      apt:
        name:
          - mysql-server
          - python3-dev
          - python3-venv
          - python3-pymysql
          - libmysqlclient-dev
          - build-essential
          - pkg-config
          - nginx
        state: present
        update_cache: yes

    - name: Start MySQL service
      service:
        name: mysql
        state: started
        enabled: yes

    - name: Create Database and User
      block:
        - mysql_db:
            name: "{{ db_name }}"
            state: present
            login_unix_socket: /var/run/mysqld/mysqld.sock
        - mysql_user:
            name: db_user
            password: "{{ db_user_password }}"
            priv: "{{ db_name }}.*:ALL"
            host: "localhost"
            state: present
            login_unix_socket: /var/run/mysqld/mysqld.sock

    - name: Prepare application directory
      file:
        path: "{{ item }}"
        state: directory
        owner: www-data
        group: www-data
        mode: "0755"
      loop:
        - "{{ app_dir }}"
        - "{{ app_dir }}/templates"

    - name: Create virtual environment
      command: python3 -m venv "{{ venv_dir }}"
      args:
        creates: "{{ venv_dir }}/bin/activate"

    - name: Install Python packages via pip
      pip:
        virtualenv: "{{ venv_dir }}"
        name:
          - flask
          - flask-mysqldb
          - mysqlclient
          - pymysql
          - gunicorn
        state: present

    - name: Copy app files and Import DB
      block:
        - copy:
            src: "{{ item.src }}"
            dest: "{{ app_dir }}/{{ item.dest }}"
          loop:
            - { src: "app.py", dest: "app.py" }
            - { src: "{{ db_sql_file }}", dest: "{{ db_sql_file }}" }
        - copy:
            src: templates/
            dest: "{{ app_dir }}/templates/"
        - mysql_db:
            name: "{{ db_name }}"
            state: import
            target: "{{ app_dir }}/{{ db_sql_file }}"
            login_unix_socket: /var/run/mysqld/mysqld.sock

    - name: Configure Nginx as Reverse Proxy
      copy:
        dest: /etc/nginx/sites-available/flask_app
        content: |
          server {
              listen 80;
              server_name _;

              location / {
                  proxy_pass http://127.0.0.1:5000;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }
          }

    - name: Enable Flask Nginx site
      file:
        src: /etc/nginx/sites-available/flask_app
        dest: /etc/nginx/sites-enabled/flask_app
        state: link

    - name: Remove default Nginx site link
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent

    - name: Configure Systemd Service for Flask
      template:
        src: templates/flaskapp.service.j2
        dest: /etc/systemd/system/flaskapp.service

    - name: Restart Flask application
      systemd:
        name: flaskapp
        state: restarted
        enabled: yes
        daemon_reload: yes

    - name: Restart Nginx
      service:
        name: nginx
        state: restarted
        enabled: yes
